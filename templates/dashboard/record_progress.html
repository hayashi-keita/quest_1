{% extends "layout.html" %}

{% block content %}
<div class="container pb-5">
  <h2 class="mb-4">ğŸ“ˆ è¨˜éŒ²æ¨ç§» - {{ user.name }} ã•ã‚“</h2>

  <!-- ğŸ”— ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã¸ã®ãƒªãƒ³ã‚¯ -->
  <div class="mb-3">
    <a href="{{ url_for('dashboard.record_profile', user_id=user.id) }}" class="btn btn-outline-primary">
      ğŸ“Š ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’è¦‹ã‚‹ï¼ˆæœ€æ–°è¨˜éŒ²æ¯”è¼ƒï¼‰
    </a>
  </div>

  <!-- âœ… ç¨®ç›®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨å…¨é¸æŠãƒœã‚¿ãƒ³ -->
  <div class="mb-4">
    <label for="metricSelector" class="form-label">è¡¨ç¤ºã™ã‚‹ç¨®ç›®ã‚’é¸æŠï¼š</label>

    <!-- å…¨é¸æŠãƒœã‚¿ãƒ³ -->
    <button type="button" id="selectAllBtn" class="btn btn-sm btn-secondary mb-2">
      âœ… å…¨ã¦ã‚’é¸æŠ
    </button>

    <select id="metricSelector" class="form-select" multiple size="8">
      <option value="run_50m" selected>50mèµ°</option>
      <option value="base_running" selected>ãƒ™ãƒ¼ã‚¹ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°</option>
      <option value="long_throw" selected>é æŠ•</option>
      <option value="pitch_speed" selected>çƒé€Ÿ</option>
      <option value="hit_speed" selected>æ‰“çƒé€Ÿåº¦</option>
      <option value="swing_speed" selected>ã‚¹ã‚¤ãƒ³ã‚°é€Ÿåº¦</option>
      <option value="bench_press" selected>ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹</option>
      <option value="squat" selected>ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆ</option>
    </select>
  </div>

  <!-- ğŸ“‰ ã‚°ãƒ©ãƒ•ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
  <canvas id="progressChart" height="120"></canvas>
</div>

<!-- âœ… Chart.js èª­ã¿è¾¼ã¿ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- âœ… JSON ãƒ‡ãƒ¼ã‚¿åŸ‹ã‚è¾¼ã¿ -->
<script id="progress-data" type="application/json">
  {{ {
    "dates": dates,
    "run_50m": run_50m,
    "base_running": base_running,
    "long_throw": long_throw,
    "pitch_speed": pitch_speed,
    "hit_speed": hit_speed,
    "swing_speed": swing_speed,
    "bench_press": bench_press,
    "squat": squat
  } | tojson | safe }}
</script>

<!-- âœ… ãƒãƒ£ãƒ¼ãƒˆæç”»ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const data = JSON.parse(document.getElementById('progress-data').textContent);

    const metrics = {
      run_50m:        { label: '50mèµ°ï¼ˆç§’ï¼‰',            data: data.run_50m,       color: 'rgba(255, 99, 132, 1)' },
      base_running:   { label: 'ãƒ™ãƒ¼ã‚¹ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°ï¼ˆç§’ï¼‰', data: data.base_running,  color: 'rgba(75, 192, 192, 1)' },
      long_throw:     { label: 'é æŠ•ï¼ˆmï¼‰',               data: data.long_throw,    color: 'rgba(153, 102, 255, 1)' },
      pitch_speed:    { label: 'çƒé€Ÿï¼ˆkm/hï¼‰',            data: data.pitch_speed,   color: 'rgba(255, 159, 64, 1)' },
      hit_speed:      { label: 'æ‰“çƒé€Ÿåº¦ï¼ˆkm/hï¼‰',        data: data.hit_speed,     color: 'rgba(255, 206, 86, 1)' },
      swing_speed:    { label: 'ã‚¹ã‚¤ãƒ³ã‚°é€Ÿåº¦ï¼ˆkm/hï¼‰',    data: data.swing_speed,   color: 'rgba(54, 162, 235, 1)' },
      bench_press:    { label: 'ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ï¼ˆkgï¼‰',       data: data.bench_press,   color: 'rgba(201, 203, 207, 1)' },
      squat:          { label: 'ã‚¹ã‚¯ãƒ¯ãƒƒãƒˆï¼ˆkgï¼‰',         data: data.squat,         color: 'rgba(0, 128, 0, 1)' }
    };

    const ctx = document.getElementById('progressChart').getContext('2d');
    let chart = null;

    function renderChart(selectedKeys) {
      const datasets = selectedKeys.map(key => ({
        label: metrics[key].label,
        data: metrics[key].data,
        borderColor: metrics[key].color,
        backgroundColor: metrics[key].color.replace('1)', '0.2)'),
        fill: false,
        tension: 0.1
      }));

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'å„é …ç›®ã®è¨˜éŒ²æ¨ç§»ï¼ˆæ‰¿èªæ¸ˆã®ã¿ï¼‰'
            },
            legend: {
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            }
          },
          interaction: {
            mode: 'nearest',
            axis: 'x',
            intersect: false
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'æ¸¬å®šå€¤'
              }
            },
            x: {
              title: {
                display: true,
                text: 'æœˆï¼ˆYYYY-MMï¼‰'
              }
            }
          }
        }
      });
    }

    // âœ… åˆæœŸè¡¨ç¤ºï¼ˆå…¨é¸æŠï¼‰
    renderChart(Object.keys(metrics));

    // âœ… ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('metricSelector').addEventListener('change', function () {
      const selected = Array.from(this.selectedOptions).map(opt => opt.value);
      renderChart(selected);
    });

    // âœ… å…¨é¸æŠãƒœã‚¿ãƒ³
    document.getElementById('selectAllBtn').addEventListener('click', function () {
      const selector = document.getElementById('metricSelector');
      for (const option of selector.options) {
        option.selected = true;
      }
      const selected = Array.from(selector.selectedOptions).map(opt => opt.value);
      renderChart(selected);
    });
  });
</script>
{% endblock %}
